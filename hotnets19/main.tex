\documentclass{hotnets19}

\usepackage{times}  
\usepackage{hyperref}
\usepackage{listings, multicol}
\usepackage{lipsum}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{mdframed}


\usepackage{float}
% \usepackage[export]{adjustbox}

\usepackage{booktabs}

\hypersetup{pdfstartview=FitH,pdfpagelayout=SinglePage}

\setlength\paperheight {11in}
\setlength\paperwidth {8.5in}
\setlength{\textwidth}{7in}
\setlength{\textheight}{9.25in}
\setlength{\oddsidemargin}{-.25in}
\setlength{\evensidemargin}{-.25in}


\definecolor{mygray}{gray}{1.0}
\definecolor{commentcolor}{RGB}{0,100,0}
\definecolor{myk}{rgb}{0.0,0,0.65}


\lstdefinelanguage{P4}{
  keywords={in, out, struct, inout, function, return, switch, enum, if, else, case, break, extern, void, bit, error, int, verify, bool, key, table, action, actions, parser, control, state, transition, select, apply},
  keywordstyle=\color{myk}\bfseries,
  keywords=[2]{boolean, string, number, objectid},
  keywordstyle=[2]\color{green}\bfseries,
  identifierstyle=\color{darkgray}\bfseries,
  sensitive=false,
  comment=[l]{//},
  morecomment=[s]{/*}{*/},
  commentstyle=\color{commentcolor}\ttfamily,
  stringstyle=\color{red}\ttfamily,
  morestring=[b]',
  morestring=[b]"
}

\lstset{
   language=P4,
%    numbers=left,
%    backgroundcolor=\color{mygray},
   extendedchars=true,
   basicstyle=\small\ttfamily\color{darkgray}\bfseries,
   showstringspaces=false,
   showspaces=false,
   tabsize=2,
   frame=single,
   breaklines=true,
   showtabs=false
}

\newcommand{\hs}[1]{{\color{blue}{HS:#1}}}

\begin{document}

% \conferenceinfo{HotNets 2019} {}
% \CopyrightYear{2019}
% \crdata{X}
% \date{}

%%%%%%%%%%%% THIS IS WHERE WE PUT IN THE TITLE AND AUTHORS %%%%%%%%%%%%

\title{MicroP4}

\author{Paper \#0, 3 pages}

\maketitle

%%%%%%%%%%%%%  ABSTRACT GOES HERE %%%%%%%%%%%%%%
\begin{abstract}

An ecosystem of programmable data plane has emerged to achieve provide high-performance with programmability by designing domain specific hardware and languages together.
The recent design of packet-processing hardware exposes programmable parsers and re-configurable match-action tables as new primitives.
P4, a domain specific language, is designed to program the re-configurable hardware based devices. 
Together, they have enabled unprecedented programmability.
This ecosystem exposes architectural details of targets' data planes along with heterogeneous abstract-machines based on the primitives.
This has led to every P4 program being target-specific and following a complex abstract-machine.
thereby, making it difficult to reuse P4 code for developing new programs and deploying on other targets.
We believe that existing ecosystem needs a better programming model that allows to develop target-agnostic P4 code libraries and reuse them.


To this end, we propose a design of logical target, MicroP4 ($\mu$P4), that provides higher-level abstractions and decouples P4 programs from real target-specific constructs.
We present a switch architecture, $\mu$SA, and a compiler, $\mu$P4C, for the logical target.
$\mu$SA defines logical constructs and generic interfaces to facilitate develop real target-agnostic code libraries and reuse them.
Using $\mu$P4C, programmers can use $\mu$SA specific P4 code libraries to develop new programs and compile it to real target-specific code.
We present the design of $\mu$SA and proof-of-concept implementation of $\mu$P4C.
\end{abstract}


% that decouples P4 programs from real target-specific constructs.
% $\mu$P4 allows programmers to express sequential and parallel execution in P4 to reuse packet-processing code.

\input{introduction}


\section{Challenges}
P4 is developed to specify data plane functionality of software or hardware targets (e.g., simple\_\-switch \cite{simple_switch.md}, TOFINO \cite{tofino} etc.,) devices.
Target device manufacturer provides an architecture description of data plane along with a P4 compiler for the device.
The architecture source file (e.g., v1\-mod\-el\-.p4 \cite{v1model.p4} for simple\_switch) contains declaration of a set of pro\-gram\-ma\-ble blocks, their data plane interfaces and the target specific metadata (called intrinsic metadata) and extern functions.
To program the packet processing pipeline of a device, P4 programmers provide implementation of the declared programmable blocks in its architecture file.
Therefore, P4 programs are tightly coupled with architecture of the target devices.

\begin{figure}[H]
    \begin{subfigure}[b]{\linewidth}
        \centering
        \includegraphics[trim=2 460 380 0, clip,scale=0.37]{v1model-pipeline.pdf}
        \caption{simple\_switch v1 Model}
        \label{subfig:v1model}
    \end{subfigure}
    \begin{subfigure}{\linewidth}
        \centering
        \includegraphics[trim=2 450 281 0, clip,scale=0.37]{psa-pipeline.pdf}
        \caption{PSA Model}
        \label{subfig:psa-model}
    \end{subfigure}
\caption{Real Target Architectures}
\label{fig:real-target-architectures}
\end{figure}

The architecture description of a target specifies data plane pipeline comprising a set of pro\-gram\-ma\-ble and fixed-function blocks, flow of user-defined and target-specific (called intrinsic) metadata in the pipeline and semantics of target-specific actions and externs.
For example, Figure \ref{subfig:psa-model} and \ref{subfig:v1model} show data plane pipelines and their packet processing blocks defined in v1model \cite{simple_switch.md} and Portable Switch Architecture (PSA) \cite{psa}, respectively.


Parser blocks are described using a sub-language of P4, based on abstraction of Finite State Machine.
Control blocks are expressed using a sub-language modelling imperative control flow.
Deparsers are special control blocks that allows to use statements, to reassemble packets, that are prohibited in other control blocks.
Packet processing logic in P4 programs are sectioned across programmable blocks with heterogeneous abstract machines (e.g., parsers, deparsers, control) and fixed-function blocks (Packet Buffer and Replication Engine).
Therefore, a control block can not instantiate and execute parser blocks. Similarly, deparser block can not invoke and execute parser blocks.  
Consider the example in Figure \ref{fig:l3.p4.l2.p4}, parser ``P'' of l2.p4 can not be executed at the end of deparser control block ``D'' of l3.p4.


Moreover, architectures models expose intrinsic metadata, target-specific actions and extern functions (e.g., resubmit, recirculate, clone) to replicate and/or program packet-path and flow of data across the processing blocks, as described in \cite{simple_switch.md} and  \cite{psa}
In turn, adding different abstract-machine to program packet-path and data flow across the blocks and further increasing heterogeneity in the model of a data plane program.
<<For example, resubmit or recirculate calls are like event trigger.. effects happen after the block>>

Finally, the existing architecture models expose target-spe\-cific constraints to programmers.
E.g., output port can not be changed in egress control block, scope of some intrinsic metadata limited to specific programmable blocks, etc.,  
Programmers need implement execution logic conforming to constraints, architecture model and semantics of actions and extern functions of the target device.


% P4 programmers need to implement homogeneous blocks (e.g., ingress and egress control) satisfying different accessibility constraints on intrinsic metadata exposed by the architecture. 

The absence of a uniform abstract machine for packet processing and presence of target-specific constraints have made extremely difficult to enable modularity.
Because, modularity requires mechanisms to develop independent code modules and interface to reuse them without requiring to know their implementation detail.
Also, existing compilers and architecture specifications do not provide simplified and common abstractions for packet processing blocks in data plane to facilitate target agnostic reuse of data plane programs.


% In section \ref{section:micros-awitch-architecture}, we explain the design of Micro Switch Architecture for a logical target that reduces number of programmable blocks and introduces logical externs to minimize heterogeneity in abstract model of P4 programs.



% \begin{figure}
%  \includegraphics[trim=3 459 281 0, clip,scale=0.35]{psa-pipeline.pdf}
%  \includegraphics[trim=3 460 357 0, clip,scale=0.35]{v1model-pipeline.pdf}
%  \includegraphics[trim=0 390 650 0, clip,scale=0.5]{v1model-pipeline-wrap.pdf}
%  \includegraphics[trim=0 380 620 0, clip,scale=0.5]{psa-pipeline-wrap.pdf}
%  \includegraphics[trim=0 482 692 0, clip,scale=0.7]{msa-pipeline.pdf}
%  \includegraphics[trim=0 450 645 0, clip,scale=0.6]{mp4c-frontend.pdf}
%  \includegraphics[trim=0 405 623 0, clip,scale=0.7]{mp4c-compiler}
%  \includegraphics[trim=0 480 805 0,clip,scale=0.5]{micro-orchestration-pipeline}
% \end{figure}

\input{mp4}
\input{msa}
\input{mp4c}

\section*{Acknowledgments}

\bibliographystyle{abbrv} 
\begin{small}
\bibliography{main}
\end{small}

\end{document}

